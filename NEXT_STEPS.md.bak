# Next Steps - Natural Gas Disruption Hook

## Current Status âœ…

### Completed
- [x] Monorepo structure setup
- [x] **Migrated from Hardhat to Foundry** (Nov 22, 2025)
- [x] Dependencies installed (@openzeppelin/contracts, Flare periphery, v4-core, v4-periphery)
- [x] NatGasToken.sol implemented (18 decimals)
- [x] MockUSDC.sol implemented (6 decimals + faucet + mint)
- [x] DisruptionOracle.sol implemented (FDC integration ready)
- [x] FeeCurve.sol library implemented (quadratic/linear/exponential)
- [x] BonusCurve.sol library implemented (quadratic/linear/sqrt + treasury-adjusted)
- [x] **NatGasDisruptionHook.sol implemented** (beforeSwap + afterSwap)
- [x] **Comprehensive unit tests written** (77 tests, 100% passing)
- [x] IMPLEMENTATION_PLAN.md created
- [x] README.md created
- [x] CLAUDE.md created (project guidelines)

### File Structure
```
ETHGlobalBuenosAires25/
â”œâ”€â”€ IMPLEMENTATION_PLAN.md       âœ… Complete technical plan
â”œâ”€â”€ README.md                     âœ… Project overview
â”œâ”€â”€ NEXT_STEPS.md                â† You are here
â”œâ”€â”€ CLAUDE.md                     âœ… Project guidelines for Claude
â”œâ”€â”€ package.json                  âœ… Workspace config
â””â”€â”€ packages/
    â””â”€â”€ contracts/
        â”œâ”€â”€ foundry.toml          âœ… Foundry config
        â”œâ”€â”€ src/
        â”‚   â”œâ”€â”€ NatGasToken.sol          âœ…
        â”‚   â”œâ”€â”€ MockUSDC.sol             âœ…
        â”‚   â”œâ”€â”€ DisruptionOracle.sol     âœ…
        â”‚   â”œâ”€â”€ NatGasDisruptionHook.sol âœ… MVP Implementation
        â”‚   â””â”€â”€ libraries/
        â”‚       â”œâ”€â”€ FeeCurve.sol         âœ…
        â”‚       â””â”€â”€ BonusCurve.sol       âœ…
        â”œâ”€â”€ test/
        â”‚   â”œâ”€â”€ NatGasToken.t.sol        âœ… 5 tests
        â”‚   â”œâ”€â”€ MockUSDC.t.sol           âœ… 8 tests
        â”‚   â”œâ”€â”€ DisruptionOracle.t.sol   âœ… 12 tests
        â”‚   â”œâ”€â”€ FeeCurve.t.sol           âœ… 14 tests
        â”‚   â”œâ”€â”€ BonusCurve.t.sol         âœ… 17 tests
        â”‚   â”œâ”€â”€ NatGasDisruptionHook.t.sol âœ… 21 tests
        â”‚   â””â”€â”€ mocks/
        â”‚       â””â”€â”€ MockPoolManager.sol  âœ…
        â”œâ”€â”€ lib/
        â”‚   â”œâ”€â”€ v4-core/             âœ… Uniswap V4 core
        â”‚   â”œâ”€â”€ v4-periphery/        âœ… Uniswap V4 periphery
        â”‚   â”œâ”€â”€ forge-std/           âœ… Foundry standard library
        â”‚   â””â”€â”€ flare-foundry-periphery-package/ âœ…
        â”œâ”€â”€ script/
        â”‚   â”œâ”€â”€ Deploy.s.sol         âœ… Main deployment script
        â”‚   â””â”€â”€ Setup.s.sol          âœ… Post-deployment setup
        â”œâ”€â”€ DEPLOYMENT.md            âœ… Deployment guide
        â”œâ”€â”€ .env.example             âœ… Environment template
        â””â”€â”€ package.json             âœ…
```

### Test Results ğŸ‰

```bash
forge test
```

**6 Test Suites | 77 Tests | 100% Pass Rate**

| Test Suite | Tests | Status |
|------------|-------|--------|
| NatGasToken.t.sol | 5 | âœ… All Pass |
| MockUSDC.t.sol | 8 | âœ… All Pass |
| DisruptionOracle.t.sol | 12 | âœ… All Pass |
| FeeCurve.t.sol | 14 | âœ… All Pass |
| BonusCurve.t.sol | 17 | âœ… All Pass |
| NatGasDisruptionHook.t.sol | 21 | âœ… All Pass |

**Total:** 77 tests passed in ~30ms

---

## Immediate Next Steps ğŸ¯

### ~~Step 1: Verify Compilation~~ âœ… COMPLETE

```bash
cd packages/contracts
forge build
```

**Result:** âœ… All contracts compile successfully with Foundry.

---

### ~~Step 2: Add Uniswap V4 Dependencies~~ âœ… COMPLETE

**Completed:** Foundry setup with v4-core and v4-periphery installed via `forge install`.

```bash
# Already done:
âœ… Foundry installed
âœ… forge install uniswap/v4-core
âœ… forge install uniswap/v4-periphery
âœ… forge install flarenetwork/flare-foundry-periphery-package
```

---

### ~~Step 3: Create Uniswap V4 Interface Definitions~~ â­ï¸ SKIPPED

**Decision:** Used direct imports from v4-core instead of creating local interfaces.

Hook imports directly from:
- `@uniswap/v4-core/src/interfaces/IPoolManager.sol`
- `@uniswap/v4-core/src/interfaces/IHooks.sol`
- `@uniswap/v4-core/src/libraries/Hooks.sol`

---

### ~~Step 4: Implement NatGasDisruptionHook.sol~~ âœ… COMPLETE

**File:** `src/NatGasDisruptionHook.sol` (240 lines)

**Implemented:**
- âœ… Hook permissions (beforeSwap + afterSwap)
- âœ… Dynamic fee calculation based on price deviation
  - Aligned traders: 0.01% fee
  - Misaligned traders: 0.3% - 10% (quadratic scaling)
- âœ… Bonus payment system for aligned traders (up to 5%)
- âœ… Treasury management (per-pool token0/token1 balances)
- âœ… Alignment detection (buying vs selling correction)
- âœ… Deviation calculation (pool price vs oracle price)
- âœ… Access control (onlyPoolManager modifier)

**MVP Simplifications:**
- Manual pool price setter (instead of reading from PoolManager)
- No treasury withdraw functions (can fund via direct transfer)
- No emergency pause/unpause
- Minimal events

---

### ~~Step 5: Write Unit Tests~~ âœ… COMPLETE

**6 test files created, 77 tests passing:**

1. **NatGasToken.t.sol** (5 tests)
   - Initial state, transfers, approvals, error handling

2. **MockUSDC.t.sol** (8 tests)
   - Faucet, minting, 6-decimal validation

3. **DisruptionOracle.t.sol** (12 tests)
   - Price updates, ownership, access control

4. **FeeCurve.t.sol** (14 tests)
   - Quadratic/linear/exponential fee calculations
   - Fee capping, growth patterns

5. **BonusCurve.t.sol** (17 tests)
   - Bonus calculations, treasury adjustments
   - Square root helper function

6. **NatGasDisruptionHook.t.sol** (21 tests)
   - Hook permissions
   - Dynamic fee logic (aligned vs misaligned)
   - Bonus payment logic
   - Deviation and alignment calculations
   - Treasury management
   - Access control

**Run tests:**
```bash
forge test          # All tests
forge test -vv      # Verbose
forge test --match-test test_BeforeSwapAlignedTraderLowFee  # Specific test
```

---

### Step 6: Write Integration Tests â­ï¸ TODO (Optional)

**Scope:** Full swap flows with real/mock PoolManager

**Create:** `test/integration/FullFlow.t.sol`

This requires:
1. Deploy or mock full V4 PoolManager
2. Initialize pool with hook
3. Add liquidity
4. Simulate multi-swap scenarios
5. Verify fee accumulation and bonus distribution
6. Test price convergence over multiple swaps

**Note:** Integration tests are complex for V4 hooks. Consider skipping for MVP and testing manually on testnet.

**Priority:** ğŸŸ¢ Low (nice-to-have)

---

### ~~Step 7: Create Deployment Scripts~~ âœ… COMPLETE

**Files created:**
1. `script/Deploy.s.sol` - Main deployment script
2. `script/Setup.s.sol` - Post-deployment setup
3. `DEPLOYMENT.md` - Comprehensive deployment guide
4. `.env.example` - Environment variable template

**Deployment order implemented:**
1. Deploy MockUSDC
2. Deploy NatGasToken
3. Deploy DisruptionOracle (base price: $100.00)
4. Deploy NatGasDisruptionHook (requires POOL_MANAGER_ADDRESS env var)

**Setup script handles:**
- Minting initial USDC to deployer
- Approving tokens for treasury funding
- Logging balances and state

**Deploy to testnet:**
```bash
# 1. Set environment variables
cp .env.example .env
# Edit .env with your PRIVATE_KEY and POOL_MANAGER_ADDRESS

# 2. Deploy all contracts
forge script script/Deploy.s.sol:Deploy --rpc-url $BASE_SEPOLIA_RPC --broadcast --verify

# 3. Run post-deployment setup (update .env with deployed addresses first)
forge script script/Setup.s.sol:Setup --rpc-url $BASE_SEPOLIA_RPC --broadcast
```

See **DEPLOYMENT.md** for full deployment guide including:
- Network RPC URLs
- Verification steps
- Local testing with Anvil
- Troubleshooting guide

**Priority:** âœ… Complete

---

### Step 8: Setup Frontend (Next.js) â­ï¸ TODO (Optional)

**Create:** `packages/frontend/`

```bash
cd packages
npx create-next-app@latest frontend --typescript --tailwind --app
cd frontend
npm install wagmi viem @tanstack/react-query
```

**Key components:**
1. **Swap Widget** - Shows dynamic fee preview based on price deviation
2. **Price Dashboard** - Displays pool price vs oracle theoretical price
3. **Disruption Feed** - Timeline of market events
4. **Faucet Component** - Mint test tokens (NATGAS, USDC)
5. **Treasury Display** - Show hook treasury balances

**Integration:**
- Connect to deployed contracts on testnet
- Use wagmi hooks for blockchain interactions
- Display real-time fee calculations
- Show bonus preview for aligned swaps

**Priority:** ğŸŸ¡ Medium (nice for demo, but not required for core testing)

---

## Blockers & Solutions ğŸš§

### ~~Blocker 1: Uniswap V4 Dependencies Not on npm~~ âœ… RESOLVED

**Solution:** Used Foundry with `forge install uniswap/v4-core` and `forge install uniswap/v4-periphery`

### ~~Blocker 2: Pool Price Calculation Complex~~ âœ… RESOLVED (MVP)

**Solution:** Implemented manual pool price setter for MVP:
```solidity
function setPoolPrice(PoolKey calldata key, uint256 price) external {
    PoolId poolId = key.toId();
    manualPoolPrice[poolId] = price;
}
```

For production, replace with actual pool price reading from PoolManager.

### Blocker 3: CREATE2 Address Requirements

V4 hooks must be deployed to specific addresses encoding their permissions.

**Solution:** Use Foundry's create2 helpers or v4-template deployment scripts for CREATE2 deployment.

**Status:** âš ï¸ TODO (required for actual V4 pool integration)

---

## Quick Reference ğŸ“š

### Important Files

| File | Purpose | Status |
|------|---------|--------|
| `IMPLEMENTATION_PLAN.md` | Full technical spec | âœ… Complete |
| `README.md` | Project overview | âœ… Complete |
| `NEXT_STEPS.md` | This file | âœ… You are here |
| `src/NatGasDisruptionHook.sol` | Main hook | âœ… Complete |
| `test/*.t.sol` | Unit tests (6 files, 77 tests) | âœ… Complete |
| `script/Deploy.s.sol` | Main deployment script | âœ… Complete |
| `script/Setup.s.sol` | Post-deployment setup | âœ… Complete |
| `DEPLOYMENT.md` | Deployment guide | âœ… Complete |
| `packages/frontend/` | Frontend UI | âŒ TODO |

### Useful Commands

```bash
# Compile contracts
cd packages/contracts
forge build

# Run tests
forge test
forge test -vv              # Verbose
forge test -vvv             # Very verbose (with traces)

# Run specific test
forge test --match-test test_BeforeSwapAlignedTraderLowFee
forge test --match-path test/NatGasDisruptionHook.t.sol

# Deploy to testnet
forge script script/Deploy.s.sol:DeployScript --rpc-url $BASE_SEPOLIA_RPC --broadcast

# Verify contract
forge verify-contract <address> NatGasDisruptionHook --chain-id 84532 --watch

# Gas report
forge test --gas-report
```

### Key Documentation Links

- [Uniswap V4 Docs](https://docs.uniswap.org/contracts/v4/overview)
- [V4 Hooks Guide](https://docs.uniswap.org/contracts/v4/guides/hooks/your-first-hook)
- [Foundry Book](https://book.getfoundry.sh/)
- [Flare Data Connector](https://dev.flare.network/fdc/overview)
- [Wagmi Docs](https://wagmi.sh/) (for frontend)
- [Viem Docs](https://viem.sh/) (for frontend)

---

## Critical Decisions ğŸ¤”

### ~~Decision 1: Hardhat vs Foundry for Hook Development~~ âœ… RESOLVED

**Decision:** Migrated to Foundry (Nov 22, 2025)
- V4 hooks are primarily Foundry-based
- Better tooling for V4 development
- Faster testing and compilation

### Decision 2: Testnet Choice

**Options:**
- Base Sepolia (recommended - L2, cheap, Uniswap support)
- Sepolia (Ethereum testnet)
- Coston2 (Flare testnet - for FDC testing)

**Recommendation:** Base Sepolia for hook testing, Coston2 for FDC integration testing.

### Decision 3: Mock V4 vs Real V4 Deployment

For hackathon purposes:
- **Option A:** Deploy to real V4 testnet pools (if available)
- **Option B:** Create simplified mock PoolManager for demo

**Current:** Using MockPoolManager for unit tests âœ…

**Next:** Determine if real V4 pools are available on Base Sepolia for integration testing.

---

## When You Return ğŸ”„

### Quickstart Checklist

1. [ ] Pull latest code: `git pull origin main`
2. [ ] Check dependencies: `cd packages/contracts`
3. [ ] Compile contracts: `forge build`
4. [ ] Run tests: `forge test`
5. [ ] Review this file for next task
6. [ ] Pick one task from "Immediate Next Steps"

### Next Task Recommendation

**Start here:** Create deployment script (Step 7)

This enables testnet deployment and integration testing.

```bash
# Create the script
touch script/Deploy.s.sol

# Set up .env
echo "PRIVATE_KEY=your_private_key_here" > .env
echo "BASE_SEPOLIA_RPC=https://sepolia.base.org" >> .env
```

---

## Success Criteria for Hackathon âœ¨

### Minimum Viable Demo (MVP)
- [x] Core contracts implemented
- [x] Hook contract working (MVP version with manual price setter)
- [x] Comprehensive unit tests (77 tests, 100% passing)
- [x] Deployment scripts ready
- [ ] Deployed to testnet (requires PoolManager address)
- [ ] Basic frontend showing:
  - Pool price vs Oracle price
  - Fee preview
  - One successful swap with bonus
- [ ] 3-minute pitch ready

### Stretch Goals
- [ ] Full Chainlink/FDC integration for live price feeds
- [ ] Multiple disruption scenarios
- [ ] Advanced fee curves
- [ ] Treasury dashboard
- [ ] Price convergence chart over multiple swaps
- [ ] CREATE2 deployment for correct hook address

---

**Last Updated:** 2025-11-23

**Next Action:** Deploy to testnet (requires PoolManager address) or build frontend (Step 8)

**Current Progress:** ğŸŸ¢ On track - Core implementation, tests, and deployment scripts complete!

**Ready to Deploy:** Scripts are ready. Need to:
1. Find or deploy a Uniswap V4 PoolManager on testnet
2. Set POOL_MANAGER_ADDRESS in .env
3. Run deployment scripts

Good luck! ğŸš€
  console.log("Deploying Oil Disruption Hook...");

  // 1. Deploy MockUSDC
  const usdc = await hre.viem.deployContract("MockUSDC");
  console.log(`MockUSDC deployed to ${usdc.address}`);

  // 2. Deploy OilToken
  const oil = await hre.viem.deployContract("OilToken");
  console.log(`OilToken deployed to ${oil.address}`);

  // 3. Deploy DisruptionOracle
  const basePrice = 100_000000n; // $100
  const oracle = await hre.viem.deployContract("DisruptionOracle", [basePrice]);
  console.log(`DisruptionOracle deployed to ${oracle.address}`);

  // 4. Deploy OilDisruptionHook
  // const hook = await hre.viem.deployContract("OilDisruptionHook", [
  //   poolManagerAddress,
  //   oracle.address
  // ]);
  // console.log(`OilDisruptionHook deployed to ${hook.address}`);

  // 5. Verify contracts
  console.log("\nVerifying contracts...");
  // Add verification logic
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
```

---

### Step 8: Setup Frontend (Next.js)

**Create:** `packages/frontend/`

```bash
cd packages
npx create-next-app@latest frontend --typescript --tailwind --app --no-src-dir
cd frontend
npm install wagmi viem @tanstack/react-query
```

Key components to build:
1. **Swap Widget** - Shows fee/bonus preview
2. **Price Dashboard** - Pool vs Oracle price
3. **Disruption Feed** - Timeline of events
4. **Faucet Component** - Mint test tokens

---

## Critical Decisions Needed ğŸ¤”

### Decision 1: Hardhat vs Foundry for Hook Development

**Current:** Hardhat 3 setup âœ…
**Issue:** V4 hooks are primarily Foundry-based
**Options:**
- A) Add Foundry alongside Hardhat (hybrid approach)
- B) Migrate fully to Foundry
- C) Continue with Hardhat and manually port V4 interfaces

**Recommendation:** Add Foundry for hook development, keep Hardhat for deployment scripts.

### Decision 2: Testnet Choice

**Options:**
- Base Sepolia (recommended - L2, cheap, Uniswap support)
- Sepolia (Ethereum testnet)
- Arbitrum Sepolia

**Recommendation:** Base Sepolia for lower gas costs.

### Decision 3: Mock V4 vs Real V4 Deployment

For hackathon purposes:
- **Option A:** Deploy to real V4 testnet pools
- **Option B:** Create simplified mock PoolManager for demo

**Recommendation:** Start with mock for faster development, migrate to real V4 if time permits.

---

## Development Workflow ğŸ”„

### Daily Development Loop

1. **Morning:** Pick next contract/feature
2. **Implement:** Write contract/test
3. **Test:** `npx hardhat test`
4. **Commit:** Git commit progress
5. **Document:** Update this file with blockers

### Git Workflow

```bash
# Create feature branch
git checkout -b feature/hook-implementation

# Commit frequently
git add .
git commit -m "feat: implement beforeSwap logic"

# Push to remote
git push origin feature/hook-implementation
```

---

## Blockers & Solutions ğŸš§

### Blocker 1: Uniswap V4 Dependencies Not on npm

**Solution:**
```bash
# Option 1: Use Foundry
forge install uniswap/v4-core

# Option 2: Manual vendor
mkdir -p contracts/vendor
# Copy interfaces from v4-core repo
```

### Blocker 2: Pool Price Calculation Complex

**Solution:** Use simplified price oracle for demo:
```solidity
// Instead of complex TWAP/sqrt price:
function getCurrentPoolPrice(PoolKey calldata key) internal view returns (uint256) {
    // For demo: use last swap price or manual setter
    return manualPoolPrice;
}
```

### Blocker 3: CREATE2 Address Requirements

V4 hooks must be deployed to specific addresses encoding their permissions.

**Solution:** Use Foundry's create2 helpers or v4-template deployment scripts.

---

## Quick Reference ğŸ“š

### Important Files

| File | Purpose | Status |
|------|---------|--------|
| `IMPLEMENTATION_PLAN.md` | Full technical spec | âœ… Complete |
| `README.md` | Project overview | âœ… Complete |
| `NEXT_STEPS.md` | This file | âœ… You are here |
| `packages/contracts/contracts/OilDisruptionHook.sol` | Main hook | âŒ TODO |
| `packages/contracts/test/` | Tests | âŒ TODO |
| `packages/frontend/` | UI | âŒ TODO |

### Useful Commands

```bash
# Compile contracts
cd packages/contracts && npx hardhat compile

# Run tests
npx hardhat test

# Run specific test
npx hardhat test test/unit/DisruptionOracle.test.ts

# Deploy to testnet
npx hardhat run scripts/deploy.ts --network baseSepolia

# Verify contract
npx hardhat verify --network baseSepolia DEPLOYED_ADDRESS constructor_args

# Start frontend
cd packages/frontend && npm run dev
```

### Key Documentation Links

- [Uniswap V4 Docs](https://docs.uniswap.org/contracts/v4/overview)
- [V4 Hooks Guide](https://docs.uniswap.org/contracts/v4/guides/hooks/your-first-hook)
- [Hardhat Docs](https://hardhat.org/docs)
- [Wagmi Docs](https://wagmi.sh/)
- [Viem Docs](https://viem.sh/)

---

## Estimated Time Breakdown â±ï¸

| Task | Time Estimate | Priority |
|------|---------------|----------|
| Setup V4 dependencies | 2-3 hours | ğŸ”´ High |
| Implement OilDisruptionHook | 4-6 hours | ğŸ”´ High |
| Write unit tests | 3-4 hours | ğŸŸ¡ Medium |
| Write integration tests | 4-5 hours | ğŸŸ¢ Low |
| Build frontend | 6-8 hours | ğŸŸ¡ Medium |
| Deploy & test on testnet | 2-3 hours | ğŸŸ¡ Medium |
| Create demo scenarios | 2-3 hours | ğŸŸ¡ Medium |
| Documentation & pitch | 2-3 hours | ğŸŸ¡ Medium |
| **Total** | **25-35 hours** | |

---

## When You Return ğŸ”„

### Quickstart Checklist

1. [ ] Pull latest code: `git pull origin main`
2. [ ] Check dependencies: `cd packages/contracts && npm install`
3. [ ] Compile contracts: `npx hardhat compile`
4. [ ] Review this file for next task
5. [ ] Pick one task from "Immediate Next Steps"
6. [ ] Update todos in this file as you progress

### First Task Recommendation

**Start here:** Complete Step 2 (Add Uniswap V4 Dependencies) using Foundry.

This unblocks all hook development.

```bash
# Install Foundry
curl -L https://foundry.paradigm.xyz | bash
foundryup

# Add to project
cd packages/contracts
forge init --force
forge install uniswap/v4-core
forge install uniswap/v4-periphery
```

---

## Questions? ğŸ¤”

Refer to:
1. **IMPLEMENTATION_PLAN.md** - Technical details
2. **README.md** - Project overview
3. **Uniswap V4 docs** - Hook architecture
4. **ETHGlobal Discord** - Community support

---

## Success Criteria for Hackathon âœ¨

### Minimum Viable Demo (MVP)
- [x] Core contracts implemented
- [ ] Hook contract working (even if simplified)
- [ ] Deployed to testnet
- [ ] Basic frontend showing:
  - Pool price vs Oracle price
  - Fee preview
  - One successful swap with bonus
- [ ] 3-minute pitch ready

### Stretch Goals
- [ ] Full Chainlink integration
- [ ] Multiple disruption scenarios
- [ ] Advanced fee curves
- [ ] Treasury dashboard
- [ ] Price convergence chart

---

**Last Updated:** 2025-11-22

**Next Action:** Add Uniswap V4 dependencies (Step 2)

Good luck! ğŸš€
